# Differential Sync & Revision/Incremental Sync

## Overview

**Differential sync** — это механизм, при котором между клиентом и сервером передаются только изменения (diff), а не полные объекты. Это позволяет:
- Сократить трафик и ускорить синхронизацию.
- Эффективно работать с большими объёмами данных.
- Минимизировать конфликты и потери данных.

## Архитектура

- Все изменения (create, update, delete) сначала сохраняются локально (offline-first, event sourcing).
- Для update в event log сохраняется только diff между старым и новым состоянием объекта.
- Для create — сохраняется весь объект, для delete — только id.
- SyncManager отправляет diff на сервер через PATCH-запросы.
- После успешной sync revision/timestamp обновляется в таблице `SyncState`.
- При загрузке данных с сервера используется параметр `since` (revision/timestamp) для инкрементальной загрузки только новых/изменённых/удалённых записей.

## Хранение revision/timestamp

- В таблице `SyncState` хранится последний revision/timestamp для каждой сущности (`account`, `category`, `transaction`).
- После успешной sync или загрузки новых данных значение обновляется.
- Используется для параметра `since` при запросах к серверу.

## Обработка удалённых записей

- Если сервер возвращает объект с `"deleted": true`, он удаляется из локальной базы.
- Если такого флага нет — запись обновляется или добавляется (upsert).

## Пример интеграции новой сущности

1. Добавьте новую таблицу и companion в Drift.
2. Реализуйте diff-логику для update (generateDiff).
3. Добавьте PATCH-метод в ApiClient.
4. В SyncManager:
   - При sync отправляйте diff через PATCH.
   - При загрузке с сервера применяйте insertOnConflictUpdate или удаляйте по флагу `deleted`.
   - Обновляйте revision/timestamp через setLastRevision.

## Edge-cases

- Конфликты: last-write-wins (по времени updatedAt).
- Offline: все изменения накапливаются локально, sync происходит при появлении сети.
- Ошибки: логируются через debugPrint, повторные попытки sync поддерживаются.

---

**Вопросы и доработки:**
- Для поддержки новых сценариев или сущностей следуйте этому шаблону.
- Для сложных конфликтов или ручного разрешения — добавьте UI/логику в presentation-слой. 